<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>CNSS Recruit 2024 Dev wp - Aununo&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Aununo&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Aununo&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="“Dev 可以成为你创造万物的途径之一，这将伴随巨大的成就感。”                        被Guideline吸引，凝聚网络安全工作室2024年💻Dev方向的招新题目，记录一下自己的wp。"><meta property="og:type" content="blog"><meta property="og:title" content="CNSS Recruit 2024 Dev wp"><meta property="og:url" content="http://aununo.xyz/2024/09/30/CNSS%20Recruit%202024%20Dev%20wp/"><meta property="og:site_name" content="Aununo&#039;s Blog"><meta property="og:description" content="“Dev 可以成为你创造万物的途径之一，这将伴随巨大的成就感。”                        被Guideline吸引，凝聚网络安全工作室2024年💻Dev方向的招新题目，记录一下自己的wp。"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://aununo.xyz/images/%E7%BC%A9%E7%95%A5%E5%9B%BE/guideline.png"><meta property="article:published_time" content="2024-09-30T14:09:09.000Z"><meta property="article:modified_time" content="2025-07-14T05:22:47.800Z"><meta property="article:author" content="Aununo Gan"><meta property="article:tag" content="Dev"><meta property="article:tag" content="CNSS"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://aununo.xyz/images/%E7%BC%A9%E7%95%A5%E5%9B%BE/guideline.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://aununo.xyz/2024/09/30/CNSS%20Recruit%202024%20Dev%20wp/"},"headline":"CNSS Recruit 2024 Dev wp","image":["http://aununo.xyz/images/%E7%BC%A9%E7%95%A5%E5%9B%BE/guideline.png"],"datePublished":"2024-09-30T14:09:09.000Z","dateModified":"2025-07-14T05:22:47.800Z","author":{"@type":"Person","name":"Aununo Gan"},"publisher":{"@type":"Organization","name":"Aununo's Blog","logo":{"@type":"ImageObject","url":"http://aununo.xyz/img/logo.svg"}},"description":"“Dev 可以成为你创造万物的途径之一，这将伴随巨大的成就感。”                        被Guideline吸引，凝聚网络安全工作室2024年💻Dev方向的招新题目，记录一下自己的wp。"}</script><link rel="canonical" href="http://aununo.xyz/2024/09/30/CNSS%20Recruit%202024%20Dev%20wp/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Aununo&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://csdiy.wiki/"><i class="fa-solid fa-arrow-right"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>CNSS Recruit 2024 Dev wp</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2024-09-30T14:09:09.000Z" title="2024-09-30T14:09:09.000Z">2024-09-30</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2025-07-14T05:22:47.800Z" title="2025-07-14T05:22:47.800Z">2025-07-14</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/categories/DevOps/">DevOps</a></span><span class="level-item"><i class="far fa-clock"></i>  an hour read (About 12177 words)</span></div></div><div class="content"><p>“Dev 可以成为你创造万物的途径之一，这将伴随巨大的成就感。”</p>
<article class="message message-immersive is-info">
    <div class="message-body">
        <i class="fas fa-info-circle mr-2"></i>
        被Guideline吸引，凝聚网络安全工作室2024年💻Dev方向的招新题目，记录一下自己的wp。
    </div>
</article>



<span id="more"></span>

<p><img src="/../images/%E7%BC%A9%E7%95%A5%E5%9B%BE/guideline.png" alt="guideline"></p>
<h2 id="🥳MAN！"><a href="#🥳MAN！" class="headerlink" title="🥳MAN！"></a>🥳MAN！</h2><p>作为一名Dev手，学会查找并浏览<strong>官方文档</strong>是非常重要的能力。本题要求你初步学会使用linux系统自带的一个功能强大的文档：<code>man</code> 。(实际上是<strong>manual</strong>的英文缩写）</p>
<ul>
<li>之前没有用过linux？没有关系，来看一下这门课程吧：<a target="_blank" rel="noopener" href="https://missing-semester-cn.github.io/">https://missing-semester-cn.github.io/</a></li>
</ul>
<h3 id="CH1"><a href="#CH1" class="headerlink" title="CH1"></a>CH1</h3><p>首先，你要在电脑上配置一个虚拟环境，这里列出几个方案:</p>
<ol>
<li>在windows环境下可以使用wsl（比较推荐）</li>
<li>或者可以配置虚拟机</li>
<li>或者有条件可以找一台云服务器或者买另一台实体机。</li>
<li>双系统（步骤比较复杂）</li>
</ol>
<p>当我们有了linux环境后，不妨在linux环境下使用gcc编译一个自己写的”Hello World!”并运行！</p>
<h3 id="CH2"><a href="#CH2" class="headerlink" title="CH2"></a>CH2</h3><p>linux有一个很有意思的指令：<code>strace</code>。同时，linux中的<strong>指令(command)<strong>，</strong>系统调用(system call)和库函数(library function)</strong> 基本都可以用<code>man 1 [name]</code>, <code>man 2 [name]</code> <code>man 3 [name]</code>来了解他们的用法。</p>
<p>假设你在CH1中的程序名为<code>hello</code>。在同目录下运行<code>strace ./hello</code>。结合你看到的<code>man</code>上对<code>strace</code>的阐述，简单解释下运行结果。</p>
<hr>
<blockquote>
<p>In  the  simplest case strace runs the specified command until it exits.  It intercepts and records the <strong>system calls</strong> which are called by a process and the <strong>signals</strong> which are received by a process.  The name of each system call, its arguments and its return value are printed on standard error or to the file  specified with the -o option.</p>
</blockquote>
<p>输出展示了程序的执行过程。</p>
<ul>
<li><code>execve</code>调用hello_world，传递了PATH、参数和42个环境变量；返回0，成功执行。</li>
<li><code>brk</code>查询程序数据段末尾位置，返回值是当前内存分配位置，用于管理内存。</li>
<li><code>mmap</code>为程序分配一块内存，返回分配的内存地址，用于读写操作。</li>
<li><code>access</code>在检查是否存在<code>ld.so.preload</code>文件，返回错误，没有找到。</li>
<li><code>openat</code>打开共享库缓存文件，查找程序依赖的共享库；当前程序依赖的libc库被打开，程序返回3。</li>
<li><code>read</code>、<code>mmap</code>和<code>close</code>表示从库中读取需要的数据。</li>
<li><code>arch_prctl</code>设置线程本地存储，为多线程环境提供支持。（不懂）</li>
<li><code>set_tid_address</code>和<code>set_robust_list</code>用于线程的初始化、设置线程的标识地址，防止线程被意外中断。（也不懂）</li>
<li><code>mprotect</code>保护内存页面的权限，设置某些内存区域为只读。</li>
<li>（大的要来了）<code>write(1, &quot;hello_world\n&quot;, 12) = 12</code>，通过write系统调用向文件描述符1即标准输出写入12个字节的字符串。</li>
<li><code>exit_group</code>顾名思义，结束并正常退出。</li>
<li>+++ exited with 0 +++</li>
</ul>
<h3 id="CH3"><a href="#CH3" class="headerlink" title="CH3"></a>CH3</h3><p>运行 <code>man 3 exec</code>。你能写一个运用到了库函数<code>exec</code>的C程序吗？</p>
<hr>
<blockquote>
<p>The  exec() family of functions replaces the current process image with a new process image.</p>
</blockquote>
<p>写程序调用execve来替换当前的进程。CH2的第一个调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>  <span class="comment">//execve所在的头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ; <span class="comment">// 引用当前进程的环境变量</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 要执行的程序的路径</span></span><br><span class="line">    <span class="type">char</span> *program = <span class="string">&quot;/bin/ls&quot;</span>; </span><br><span class="line">    <span class="comment">// 参数</span></span><br><span class="line">    <span class="type">char</span> *args[] = &#123;<span class="string">&quot;ls&quot;</span>, <span class="literal">NULL</span>&#125;; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行 execve 系统调用</span></span><br><span class="line">    <span class="keyword">if</span> (execve(program, args, environ) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;execve met problems.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);  <span class="comment">// 使用 EXIT_FAILURE 表示失败退出</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译和运行这个程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o execve_exp execve_exp.c</span><br><span class="line">$ ./execve_exp</span><br><span class="line">execve_exp  execve_exp.c  hello_world  test.c</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">execve_exp  execve_exp.c  hello_world  test.c</span><br></pre></td></tr></table></figure>





<h2 id="😶‍🌫️Oop-Loop"><a href="#😶‍🌫️Oop-Loop" class="headerlink" title="😶‍🌫️Oop Loop"></a>😶‍🌫️Oop Loop</h2><p>学习c语言的数组部分时，想出了三种遍历二维数组的方法，并想办法测量了这三种方法所使用的时间。”这三种方法都访问了<strong>同样数量</strong>的数组元素，因此他们所耗费的时间一定是差不多的。“但事情远没有这么简单：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNIT_GAP 1000000.0</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">M_gettimeofday</span><span class="params">(<span class="keyword">struct</span> timeval *tv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> result = gettimeofday(tv, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(result != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;gettimeofday st\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ArrSize 15000</span></span><br><span class="line"><span class="type">int</span> arr1[ArrSize][ArrSize];</span><br><span class="line"><span class="type">int</span> arr2[ArrSize][ArrSize];</span><br><span class="line"><span class="type">int</span> arr3[ArrSize][ArrSize];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/* Evaluate iterating pattern 1 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv_st</span>;</span></span><br><span class="line">    M_gettimeofday(&amp;tv_st);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ArrSize; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; ArrSize; j++) &#123;</span><br><span class="line">            arr1[i][j] += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv_ed</span>;</span></span><br><span class="line">    M_gettimeofday(&amp;tv_ed);</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> time_gap1 = (<span class="type">double</span>) (tv_ed.tv_sec - tv_st.tv_sec) + ((<span class="type">double</span>) (tv_ed.tv_usec -  tv_st.tv_usec) / UNIT_GAP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Evaluate iterating pattern 2 */</span></span><br><span class="line">    M_gettimeofday(&amp;tv_st);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ArrSize; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; ArrSize; j++) &#123;</span><br><span class="line">            arr2[j][i] += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    M_gettimeofday(&amp;tv_ed);</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> time_gap2 = (<span class="type">double</span>) (tv_ed.tv_sec - tv_st.tv_sec) + ((<span class="type">double</span>) (tv_ed.tv_usec -  tv_st.tv_usec) / UNIT_GAP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Evaluate iterating pattern 3 */</span></span><br><span class="line">    M_gettimeofday(&amp;tv_st);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ArrSize; i++) &#123;</span><br><span class="line">        <span class="type">int</span> cap = (ArrSize / <span class="number">3</span>) * <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; cap; j+=<span class="number">3</span>) &#123;</span><br><span class="line">            arr3[i][j] += <span class="number">1</span>;</span><br><span class="line">            arr3[i][j + <span class="number">1</span>] += <span class="number">1</span>;</span><br><span class="line">            arr3[i][j + <span class="number">2</span>] += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = cap; j &lt; ArrSize; j++) &#123;</span><br><span class="line">            arr3[i][j] += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    M_gettimeofday(&amp;tv_ed);</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> time_gap3 = (<span class="type">double</span>) (tv_ed.tv_sec - tv_st.tv_sec) + ((<span class="type">double</span>) (tv_ed.tv_usec -  tv_st.tv_usec) / UNIT_GAP);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;time spent for time_gap1: %lf seconds\n&quot;</span>, time_gap1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;time spent for time_gap2: %lf seconds\n&quot;</span>, time_gap2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;time spent for time_gap3: %lf seconds\n&quot;</span>, time_gap3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事实上，这三种遍历方式使用的时间有明显的差别。</p>
<h3 id="CH1-1"><a href="#CH1-1" class="headerlink" title="CH1"></a>CH1</h3><p>发现每次程序的运行结果差别都很大，因此需要反复运行程序很多次才能找出不同遍历模式下的时间规律。请你帮他修改程序，让程序的运行结果随机性更小，这样就能找出更加可信的结论了！</p>
<hr>
<p>实践出真知，跑一下看看。Oops，感觉1和3的随机性很强，2几乎是最慢的，不过也有少数例外。为了减少随机性，我们可以多次跑代码取平均值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNIT_GAP 1000000.0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ArrSize 15000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_RUNS 5 <span class="comment">//运行5次并取平均值</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">M_gettimeofday</span><span class="params">(<span class="keyword">struct</span> timeval *tv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> result = gettimeofday(tv, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(result != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;gettimeofday failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> arr1[ArrSize][ArrSize];</span><br><span class="line"><span class="type">int</span> arr2[ArrSize][ArrSize];</span><br><span class="line"><span class="type">int</span> arr3[ArrSize][ArrSize];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">double</span> total_time1 = <span class="number">0.0</span>, total_time2 = <span class="number">0.0</span>, total_time3 = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> run = <span class="number">0</span>; run &lt; NUM_RUNS; run++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv_st</span>, <span class="title">tv_ed</span>;</span></span><br><span class="line">        M_gettimeofday(&amp;tv_st);</span><br><span class="line">                 <span class="comment">/* PATTERN 1 */</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ArrSize; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; ArrSize; j++) &#123;</span><br><span class="line">                arr1[i][j] += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        M_gettimeofday(&amp;tv_ed);</span><br><span class="line">        <span class="type">double</span> time_gap1 = (<span class="type">double</span>) (tv_ed.tv_sec - tv_st.tv_sec) + </span><br><span class="line">                           ((<span class="type">double</span>) (tv_ed.tv_usec - tv_st.tv_usec) / UNIT_GAP);</span><br><span class="line">        total_time1 += time_gap1;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        M_gettimeofday(&amp;tv_st);</span><br><span class="line">                 <span class="comment">/* PATTERN 2 */</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ArrSize; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; ArrSize; j++) &#123;</span><br><span class="line">                arr2[j][i] += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        M_gettimeofday(&amp;tv_ed);</span><br><span class="line">        <span class="type">double</span> time_gap2 = (<span class="type">double</span>) (tv_ed.tv_sec - tv_st.tv_sec) + </span><br><span class="line">                           ((<span class="type">double</span>) (tv_ed.tv_usec - tv_st.tv_usec) / UNIT_GAP);</span><br><span class="line">        total_time2 += time_gap2;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        M_gettimeofday(&amp;tv_st);</span><br><span class="line">                 <span class="comment">/* PATTERN 3 */</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ArrSize; i++) &#123;</span><br><span class="line">            <span class="type">int</span> cap = (ArrSize / <span class="number">3</span>) * <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; cap; j += <span class="number">3</span>) &#123;</span><br><span class="line">                arr3[i][j] += <span class="number">1</span>;</span><br><span class="line">                arr3[i][j + <span class="number">1</span>] += <span class="number">1</span>;</span><br><span class="line">                arr3[i][j + <span class="number">2</span>] += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = cap; j &lt; ArrSize; j++) &#123;</span><br><span class="line">                arr3[i][j] += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        M_gettimeofday(&amp;tv_ed);</span><br><span class="line">        <span class="type">double</span> time_gap3 = (<span class="type">double</span>) (tv_ed.tv_sec - tv_st.tv_sec) + </span><br><span class="line">                           ((<span class="type">double</span>) (tv_ed.tv_usec - tv_st.tv_usec) / UNIT_GAP);</span><br><span class="line">        total_time3 += time_gap3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Average time spent for time_gap1: %lf seconds\n&quot;</span>, total_time1 / NUM_RUNS);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Average time spent for time_gap2: %lf seconds\n&quot;</span>, total_time2 / NUM_RUNS);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Average time spent for time_gap3: %lf seconds\n&quot;</span>, total_time3 / NUM_RUNS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>嗯，看起来有规律多了：$2&gt;&gt;1&gt;3$。</p>
<h3 id="CH2-1"><a href="#CH2-1" class="headerlink" title="CH2"></a>CH2</h3><p>试回答不同遍历模式下运行时间的差别，并解释为什么会产生这些差别。</p>
<hr>
<p>1是行优先遍历，这与C中<strong>行主序</strong>存储数组的方式一致。根据局部性，CPU可以有效地读取连续的内存块，减少缓存未命中次数，提高访问速度。</p>
<p>而2是列优先遍历，与1相反，这种访问模式导致大量缓存未命中、效率低。</p>
<blockquote>
<p>关于原理解释那一部分，只靠cpu缓存其实不太能解释 第三个pattern 耗时比第一个pattern小的问题qwq——Shiver</p>
</blockquote>
<p>3则使用了<strong>循环展开</strong>优化。每次处理三个元素，减少了每次更新迭代的控制开销，在大规模进行数组遍历时，会累积成明显的性能提升。</p>
<p>另外由于数组元素是每三个访问的，更容易预取更多数据到<strong>缓存</strong>中，进一步减少了缓存未命中的损失。</p>
<p><strong>流水线</strong>优化：现代处理器使用流水线技术来提高指令执行的效率。3通过减少循环次数和增加每次循环内处理的数据量，减少了其它分支指令，使处理器流水线更顺畅。这可以减少流水线停顿，从而提高整体执行速度。</p>
<p><strong>分支预测</strong>：循环的检查条件变少了，分支预测错误的概率也降低了。</p>
<p>可能存在的<strong>向量化</strong>优化？编译器可以自动将这种每次操作多个相邻元素转换为SIMD指令。这意味着处理器可以在一个指令周期内对多个数据进行相同的操作，提升运算速度。</p>
<p>连续访问多个元素更有可能保持内存对齐，从而减少额外的内存操作开销。</p>
<p>由于循环体内操作相互独立，处理器可以并行处理多个操作，进一步提升速度。</p>
<h2 id="♿造轮子"><a href="#♿造轮子" class="headerlink" title="♿造轮子"></a>♿造轮子</h2><blockquote>
<p>Git 是一个分布式版本控制系统，用于跟踪代码或文件的更改，并支持多人协作开发。</p>
<p>你可以在这里看到git的源代码: <a target="_blank" rel="noopener" href="https://github.com/git/git">https://github.com/git/git</a></p>
</blockquote>
<p>Shiver想要在自己的电脑上安装<code>git</code>。</p>
<p>以前，他是通过系统的软件包管理器来安装<code>git</code>的。例如，在ubuntu系统中就可以使用这两行命令来安装git：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt update</span><br><span class="line">$ <span class="built_in">sudo</span> apt install git</span><br></pre></td></tr></table></figure>

<p>但今天，它想换点新花样。他想要通过源代码来编译<code>git</code>！</p>
<blockquote>
<p>git的源代码很多地方都有，这里比较推荐使用github上的代码仓库，并通过git clone下载。（不要吐槽为什么电脑上已经有git了为为什么还要下载git源码）</p>
</blockquote>
<p>同时，<code>Shiver</code>还通过修改源代码实现了修改git调用版本信息后的输出。</p>
<p>总的来说，Shiver想要你实现如下的操作：</p>
<ol>
<li>在自己的电脑上编译 <code>git</code> 程序，并在提交文档中简单阐述自己在编译过程中遇到的问题与自己是怎么解决这些问题的。</li>
<li>修改 <code>git</code> 的源代码，使其在输出版本信息时会有额外的 <code>&lt;-- CNSS --&gt;</code> 提示（你也可以添加自己喜欢的信息）并截图提交。（这可能需要你具有一定的代码阅读能力）</li>
</ol>
<p>Hints：</p>
<ul>
<li>怎么编译？要不先从文档开始，比如源代码中的<code>README.md</code>，<code>INSTALL</code>文件？</li>
<li>什么是cmake？</li>
</ul>
<hr>
<p>A）编译需要依赖，在GPT的帮助下怒装依赖项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install -y make libssl-dev libcurl4-gnutls-dev libexpat1-dev gettext</span><br></pre></td></tr></table></figure>

<p>B）获取Git的源码并编译Git程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:git/git.git</span><br><span class="line">make configure</span><br><span class="line">./configure --prefix=/usr/local <span class="comment">#指定安装路径，防止冲突</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>C）遇到报错信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: libgit.a(utf8.o): <span class="keyword">in</span> <span class="keyword">function</span> `reencode_string_iconv<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">/home/aununo/CNSS/git/utf8.c:498:(.text+0x10dd): undefined reference to `libiconv&#x27;</span></span><br><span class="line">/usr/bin/ld: libgit.a(utf8.o): <span class="keyword">in</span> <span class="keyword">function</span> `reencode_string_len<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">/home/aununo/CNSS/git/utf8.c:593:(.text+0x121d): undefined reference to `libiconv_open&#x27;</span></span><br><span class="line">/usr/bin/ld: /home/aununo/CNSS/git/utf8.c:603:(.text+0x1252): undefined reference to `libiconv_close<span class="string">&#x27;</span></span><br><span class="line"><span class="string">/usr/bin/ld: /home/aununo/CNSS/git/utf8.c:593:(.text+0x129e): undefined reference to `libiconv_open&#x27;</span></span><br><span class="line">/usr/bin/ld: /home/aununo/CNSS/git/utf8.c:603:(.text+0x12c9): undefined reference to `libiconv_close<span class="string">&#x27;</span></span><br><span class="line"><span class="string">/usr/bin/ld: /home/aununo/CNSS/git/utf8.c:598:(.text+0x136b): undefined reference to `libiconv_open&#x27;</span></span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make: *** [Makefile:2842: git-daemon] Error 1</span><br></pre></td></tr></table></figure>

<p>大概是说缺少 <code>libiconv</code> 库的引用。<code>libiconv</code> 是一个用于字符编码转换的库，而 Git 在处理字符集转换时依赖于它。我们使用命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ldconfig -p | grep libiconv <span class="comment">#检查libiconv是否成功安装</span></span><br><span class="line">        libiconv_hook.so.1 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libiconv_hook.so.1</span><br><span class="line">        libiconv_hook.so (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libiconv_hook.so</span><br></pre></td></tr></table></figure>

<p>系统上有 <code>libiconv_hook.so</code>，而不是标准的 <code>libiconv.so</code>。由于 <code>libiconv_hook</code> 并没有提供 <code>libiconv.so</code> 的标准接口，导致了编译和测试时出现错误。创建符号链接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /lib/x86_64-linux-gnu/libiconv_hook.so.1 /lib/x86_64-linux-gnu/libiconv.so.2</span><br></pre></td></tr></table></figure>

<p>让系统中的 <code>libiconv_hook.so</code> 模拟 <code>libiconv.so.2</code>，验证一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ldconfig -p | grep libiconv</span><br><span class="line">        libiconv_hook.so.1 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libiconv_hook.so.1</span><br><span class="line">        libiconv_hook.so (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libiconv_hook.so</span><br><span class="line">        libiconv.so.2 (libc6,x86-64) =&gt; /usr/local/lib/libiconv.so.2</span><br><span class="line">        libiconv.so (libc6,x86-64) =&gt; /usr/local/lib/libiconv.so</span><br></pre></td></tr></table></figure>

<p>然后进行make编译成功！再复现一遍。</p>
<ul>
<li><p>使用的版本基于 <code>2.46.2</code>，并且在此版本发布后有 628 次提交。</p>
</li>
<li><p>当前版本对应的具体提交哈希是 <code>6258f68c3c</code>。（复现前后面还有个<code>.dirty</code>表示在工作目录中有未提交的更改）</p>
</li>
</ul>
<p>Git 的版本信息由 <code>git --version</code> 命令生成，输出git version，下面我们进行查找：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">&quot;git version&quot;</span> .</span><br></pre></td></tr></table></figure>

<p>把大量输出喂给GPT发现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./help.c:        * with external projects that rely on the output of <span class="string">&quot;git version&quot;</span>.</span><br><span class="line">./help.c:       strbuf_addf(buf, <span class="string">&quot;git version %s\n&quot;</span>, git_version_string);</span><br><span class="line">./help.c:               N_(<span class="string">&quot;git version [--build-options]&quot;</span>),</span><br></pre></td></tr></table></figure>

<p>Here it is! 在vscode中查找并编辑help.c文件，修改输出即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strbuf_addf(buf, <span class="string">&quot;git version %s\n&quot;</span>, git_version_string);</span><br><span class="line">=&gt;   strbuf_addf(buf, <span class="string">&quot;&lt;-- CNSS --&gt; git version %s I l0v3 Sh1v3r~\n&quot;</span>, git_version_string);</span><br></pre></td></tr></table></figure>

<p>重新make一下，输出时发现后面多了一个dirty。是修改了help.c却没提交更改的缘故。</p>
<p>可以看到输出<code>&lt;-- CNSS --&gt; git version 2.46.2.628.g6258f68c3c.dirty I l0v3 Sh1v3r~</code></p>
<h2 id="⚒️Dig-and-Dig"><a href="#⚒️Dig-and-Dig" class="headerlink" title="⚒️Dig and Dig"></a>⚒️Dig and Dig</h2><blockquote>
<p>ssg是一名资深的Minecraft玩家，平时最喜欢的就是在MC的辽阔土地上寻找珍贵的矿石。</p>
</blockquote>
<h3 id="CH1-2"><a href="#CH1-2" class="headerlink" title="CH1"></a>CH1</h3><p>从原版到整合包，从我的世界到泰拉瑞亚，ssg挖矿的足迹分布在各个领域。</p>
<p>有一天，他突然好奇想挖挖看 C语言程序，于是他写下了这段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> depth;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Dig</span> <span class="params">(<span class="type">int</span> digging)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (digging &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> where_are_we;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;In depth %d, we are at %p \n&quot;</span>, (depth - digging), (<span class="type">void</span> *) &amp;where_are_we);</span><br><span class="line"></span><br><span class="line">    Dig(digging - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Today we will dig: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;depth);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let begin!\n&quot;</span>);</span><br><span class="line">    Dig(depth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他决定先向下面挖掘 10 个函数的深度，于是他将<code>depth</code> 变量设置为了 10 并得到了这样的结果：</p>
<blockquote>
<p>Today we will dig: 10<br>Let begin!<br>In depth 0, we are at 0x7fffbc3fea14<br>In depth 1, we are at 0x7fffbc3fe9e4<br>In depth 2, we are at 0x7fffbc3fe9b4<br>In depth 3, we are at 0x7fffbc3fe984<br>In depth 4, we are at 0x7fffbc3fe954<br>In depth 5, we are at 0x7fffbc3fe924<br>In depth 6, we are at 0x7fffbc3fe8f4<br>In depth 7, we are at 0x7fffbc3fe8c4<br>In depth 8, we are at 0x7fffbc3fe894<br>In depth 9, we are at 0x7fffbc3fe864<br>In depth 10, we are at 0x7fffbc3fe834</p>
</blockquote>
<p>看起来不错，于是他决定继续向下挖，但不知道为什么，当 <code>depth</code> 足够大时，程序就终止运作了！</p>
<p>因此 ssg 找到你，想请你帮他解决这些问题：</p>
<ol>
<li>尝试修改程序，使ssg的这个程序能统计他 <strong>总共</strong> 能够向下挖掘多少个 Byte。多次运行这个程序，每次能向下挖的Byte是固定的吗？</li>
</ol>
<p>运行初始程序看看depth的最大值，发现每次运行得到的最大深度相近但不同。比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./dig</span><br><span class="line">Today we will dig: 1000000</span><br><span class="line">Let begin!</span><br><span class="line">...</span><br><span class="line">In depth 174513, we are at 0x7ffcccda07a4</span><br><span class="line">[1]    2146 segmentation fault  ./dig</span><br><span class="line"><span class="comment"># ----------------------------------- #</span></span><br><span class="line">In depth 174450, we are at 0x7ffda0d677a4</span><br><span class="line">[1]    2165 segmentation fault  ./dig</span><br><span class="line"><span class="comment"># ----------------------------------- #</span></span><br><span class="line">In depth 174576, we are at 0x7ffc72f5f7a4</span><br><span class="line">[1]    2688 segmentation fault  ./dig</span><br></pre></td></tr></table></figure>

<p>第一次运行，程序在<code>174513</code>处崩溃，而第二次运行在<code>174450</code>处崩溃，操作系统为进程分配的栈空间每次可能会略有不同，因此这些深度值并不完全一致。segmentation fault的段错误发生在程序试图访问未被允许访问的内存区域时。</p>
<blockquote>
<p>[1] 是Linux系统为每个后台任务分配的作业号，1表示这是当前会话的第一个后台进程。</p>
<p>2146和2165是进程ID，是系统为每个运行程序分配的唯一标识符。</p>
</blockquote>
<p>记录一下初始地址，用where_are_we减初始地址得到所在深度：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> depth;</span><br><span class="line"><span class="type">void</span> *initial_address = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Dig</span> <span class="params">(<span class="type">int</span> digging)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (digging &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> where_are_we;</span><br><span class="line">    <span class="keyword">if</span> (initial_address == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        initial_address = &amp;where_are_we;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> current_depth_bytes = <span class="built_in">abs</span>((<span class="type">char</span> *) initial_address - (<span class="type">char</span> *) &amp;where_are_we);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;In depth %d, we are at %p, depth in bytes: %d \n&quot;</span>, (depth - digging), (<span class="type">void</span> *) &amp;where_are_we, current_depth_bytes);</span><br><span class="line"></span><br><span class="line">    Dig(digging - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Today we will dig: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;depth);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let begin!\n&quot;</span>);</span><br><span class="line">    Dig(depth);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行一下程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./dig</span><br><span class="line">Today we will dig: 100</span><br><span class="line">Let begin!</span><br><span class="line">In depth 0, we are at 0x7ffdd7afae10, depth <span class="keyword">in</span> bytes: 0</span><br><span class="line">In depth 1, we are at 0x7ffdd7afade0, depth <span class="keyword">in</span> bytes: 48</span><br><span class="line">...</span><br><span class="line">In depth 100, we are at 0x7ffdd7af9b50, depth <span class="keyword">in</span> bytes: 4800</span><br></pre></td></tr></table></figure>

<p>发现每次能向下挖的字节数是固定的48字节。</p>
<ol start="2">
<li>尝试解释为什么<code>depth</code>足够大时程序会停止运行。</li>
</ol>
<p>递归深度过深，发生了栈溢出。函数的递归调用会在栈上分配内存，而栈的大小是有限的。当递归深度超出系统分配给程序的栈内存时，程序就会发生栈溢出，从而导致程序崩溃。</p>
<ol start="3">
<li>尝试解释为什么每次层数的间隔都为 48Byte, 这48Byte里面都包含了些什么？</li>
</ol>
<p>函数调用过程中的栈帧结构，说明这个函数中一个栈帧大小为48byte。包含：函数的返回地址，局部变量，函数参数等。</p>
<p>比如将函数内部的局部变量where_are_we类型改为long时，层数间隔会变为64byte。</p>
<h3 id="CH2-2"><a href="#CH2-2" class="headerlink" title="CH2"></a>CH2</h3><p>ssg在挖矿的时候是左右手交替进行的，因此他想记录下自己在挖掘每一层时使用的是左手还是右手，于是他写下了这段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> depth;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">WhichHand</span><span class="params">(<span class="type">bool</span> hand)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hand ? <span class="string">&quot;left hand&quot;</span> : <span class="string">&quot;right hand&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">Dig1</span> <span class="params">(<span class="type">int</span> digging)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( digging &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> now_hand = !Dig1(digging - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;In depth %d, we use %s \n&quot;</span>, (depth - digging), WhichHand(now_hand));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> now_hand;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">Dig2</span> <span class="params">(<span class="type">int</span> digging, <span class="type">bool</span> hand)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( digging &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> hand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;In depth %d, we use %s \n&quot;</span>, (depth - digging), WhichHand(hand));</span><br><span class="line">    <span class="keyword">return</span> Dig2(digging - <span class="number">1</span>, !hand);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Today we will dig: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;depth);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let begin!\n&quot;</span>);</span><br><span class="line">    Dig1(depth);</span><br><span class="line">    <span class="comment">//Dig2(depth, 0);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Dig1</code>和<code>Dig2</code>是他编写的两个不同版本但是效果相似的函数，看起来运行的不错：</p>
<blockquote>
<p>Today we will dig: 10<br>Let begin!<br>In depth 10, we use left hand<br>In depth 9, we use right hand<br>In depth 8, we use left hand<br>In depth 7, we use right hand<br>In depth 6, we use left hand<br>In depth 5, we use right hand<br>In depth 4, we use left hand<br>In depth 3, we use right hand<br>In depth 2, we use left hand<br>In depth 1, we use right hand<br>In depth 0, we use left hand</p>
</blockquote>
<p>但ssg发现了一个很严重的问题，当他使用 <strong>O2 优化</strong>(即在gcc编译时添加<code>-O2</code>指令)分别编译运行了两个不同版本的函数后，有一个版本的函数，无论他将深度设置为多大，都可以正常运行！</p>
<p>他现在想考考你:</p>
<ol>
<li>哪个版本的函数无论设置多大的深度都可以正常运行？</li>
</ol>
<p><code>dig2</code>函数。我们来跑一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -O2 -o dig1 dig1.c <span class="comment">#O2优化启用了包括-Wunused-result在内的警告，检查scanf返回值</span></span><br><span class="line">dig1.c: In <span class="keyword">function</span> ‘main’:</span><br><span class="line">dig1.c:34:5: warning: ignoring <span class="built_in">return</span> value of ‘scanf’ declared with attribute ‘warn_unused_result’ [-Wunused-result]</span><br><span class="line">   34 |     scanf(<span class="string">&quot;%d&quot;</span>, &amp;depth);</span><br><span class="line">      |</span><br><span class="line">$ ./dig1</span><br><span class="line">Today we will dig: 1000000</span><br><span class="line">Let begin!</span><br><span class="line">[1]    1727 segmentation fault  ./dig</span><br><span class="line"><span class="comment"># ----------------------------------- #</span></span><br><span class="line">$ ./dig2</span><br><span class="line">Today we will dig: 1000000</span><br><span class="line">Let begin!</span><br><span class="line">...</span><br><span class="line">In depth 999999, we use left hand</span><br><span class="line">In depth 1000000, we use right hand</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>为什么？</li>
</ol>
<p>dig1函数仍然是使用了普通递归的方式，即使开O2优化编译，栈空间的限制依然存在。</p>
<p>而dig2函数使用尾递归，大多数编译器，比如这里的gcc中，开了O2尾递归可以被优化为普通循环实现，每次递归不需要额外占用栈帧，只需将函数参数改变再调用一次，就不会触发栈溢出。</p>
<ol start="3">
<li>谈一谈这道题对你在实际项目开发中的启发。</li>
</ol>
<ul>
<li>用递归，深度较大时，警惕栈溢出；</li>
<li>合理使用尾递归；</li>
<li>了解编译器和语言的优化能力，有助于提高程序的运行效率；</li>
<li>developers应当编写健壮的代码，做好代码测试，关注边界条件。</li>
</ul>
<h2 id="🧮Primes"><a href="#🧮Primes" class="headerlink" title="🧮Primes"></a>🧮Primes</h2><p>香肠非常痴迷于筛法求素数表，大致原理如下<br><img src="https://pic.timlzh.com/i/2024/09/22/10eldpv.png" alt="2"></p>
<p>于是他先用 JavaScript 编写了下面这样的代码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>* <span class="title function_">iota</span>(<span class="params">i, n</span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; n) <span class="keyword">yield</span> i++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">filter</span>(<span class="params">g, p</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (x <span class="keyword">of</span> g) &#123;</span><br><span class="line">    <span class="keyword">if</span> (x % p) <span class="keyword">yield</span> x</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g = <span class="title function_">iota</span>(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> &#123;value, done&#125; = g.<span class="title function_">next</span>()</span><br><span class="line">  <span class="keyword">if</span> (done) <span class="keyword">break</span></span><br><span class="line">  g = <span class="title function_">filter</span>(g, value)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序成功打印了 100 以内的所有素数。</p>
<p>为了让更多人理解这段代码，他又编写了 Python 版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">iota</span>(<span class="params">i, n</span>):</span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">g, p</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> g:</span><br><span class="line">        <span class="keyword">if</span> x % p:</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line">g = iota(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        value = <span class="built_in">next</span>(g)</span><br><span class="line">        g = <span class="built_in">filter</span>(g, value)</span><br><span class="line">        <span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>程序虽然正确，但 IDE 给出了警告：用户定义的 filter 函数隐藏了 Python 内置的 filter 函数。</p>
<p>说来也是，为什么不直接使用更泛化的内置 filter 函数呢？于是他又把程序改成了这样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">iota</span>(<span class="params">i, n</span>):</span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">g = iota(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        value = <span class="built_in">next</span>(g)</span><br><span class="line">        g = <span class="built_in">filter</span>(<span class="keyword">lambda</span> incoming: incoming % value, g)</span><br><span class="line">        <span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>很遗憾的是，程序输出的结果不再正确。到底是哪里出了问题？</p>
<hr>
<p>在调试的过程中，香肠觉得不能光调 Python 代码，JavaScript 的也不能放过。</p>
<p>考虑到 Python 采用了更泛化 filter 函数，于是他把原 JavaScript 代码也改成了这样。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>* <span class="title function_">iota</span>(<span class="params">i, n</span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; n) <span class="keyword">yield</span> i++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">filter</span>(<span class="params">g, p</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (x <span class="keyword">of</span> g) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">p</span>(x)) <span class="keyword">yield</span> x</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g = <span class="title function_">iota</span>(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> &#123;value, done&#125; = g.<span class="title function_">next</span>()</span><br><span class="line">  <span class="keyword">if</span> (done) <span class="keyword">break</span></span><br><span class="line">  g = <span class="title function_">filter</span>(g, <span class="function"><span class="params">incoming</span> =&gt;</span> incoming % value)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>竟然出现了和第二份 Python 代码一样的错误输出结果。这是巧合吗？</p>
<ul>
<li>本题筛素数的协程叫什么协程？你能简单描述一下这样筛素数的过程吗？</li>
</ul>
<p>在JavaScript或Python中，利用惰性求值的生成器，可以逐步生成一个序列，并能在筛选过程中动态修改序列，避免占用过多计算资源。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">g = <span class="title function_">iota</span>(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> &#123;value, done&#125; = g.<span class="title function_">next</span>()</span><br><span class="line">  <span class="keyword">if</span> (done) <span class="keyword">break</span></span><br><span class="line">  g = <span class="title function_">filter</span>(g, value)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心思想是埃拉托斯特尼筛法（Sieve of Eratosthenes）。生成器iota生成一个从2到99的整数序列g，每次调用g中的值并通过生成器filter筛掉素数value的倍数，输出value，再移动到下一个数进行循环。</p>
<ul>
<li><p>为什么第二份 Python 和第二份 JavaScript 的代码有问题？两者的问题是一样的吗？</p>
</li>
<li><p>请你在第二份 Python 和第二份 JavaScript 基础上修改代码，在不失一般性的情况下解决存在的问题。</p>
</li>
</ul>
<p>两者的问题不一样。</p>
<p>Python是和其<strong>延时绑定</strong>的机制有关。Python在真正执行函数（如lambda）的时候才会查找变量的值，而不是在定义函数时。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g = <span class="built_in">filter</span>(<span class="keyword">lambda</span> incoming: incoming % value, g)</span><br></pre></td></tr></table></figure>

<p>而在同一个作用域下，value的值始终针对同一个变量在变化，而不是每次循环都创建一个新变量。因此，所有的lambda中引用的value都会使用最新的值。</p>
<p>可以采用<strong>默认参数</strong>的方法解决这个问题。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">iota</span>(<span class="params">i, n</span>):</span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">g = iota(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        value = <span class="built_in">next</span>(g)</span><br><span class="line">        g = <span class="built_in">filter</span>(<span class="keyword">lambda</span> incoming, value=value: incoming % value, g)</span><br><span class="line">        <span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>这样，参数只会初始化一次，而在之后的循环中保持不变。</p>
<p>手动即时捕获。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">iota</span>(<span class="params">i, n</span>):</span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">g = iota(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        value = <span class="built_in">next</span>(g)</span><br><span class="line">        g = <span class="built_in">filter</span>((<span class="keyword">lambda</span> value: <span class="keyword">lambda</span> incoming: incoming % value)(value), g)</span><br><span class="line">        <span class="built_in">print</span>(value)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>而JavaScript是与var的作用域规则有关。var在JavaScript中的作用域是函数作用域，而不是块作用域。循环体中每次声明的value实际上会在整个函数的作用域中共享，lambda函数捕获的是对同一个变量的引用，所以value会在每次循环后更新。</p>
<p>可以使用 <code>let</code> 代替 <code>var</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>* <span class="title function_">iota</span>(<span class="params">i, n</span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; n) <span class="keyword">yield</span> i++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">filter</span>(<span class="params">g, p</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (x <span class="keyword">of</span> g) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">p</span>(x)) <span class="keyword">yield</span> x</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g = <span class="title function_">iota</span>(<span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123;value, done&#125; = g.<span class="title function_">next</span>()</span><br><span class="line">  <span class="keyword">if</span> (done) <span class="keyword">break</span></span><br><span class="line">  g = <span class="title function_">filter</span>(g, <span class="function"><span class="params">incoming</span> =&gt;</span> incoming % value)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 <code>let</code> 是块作用域，在每次循环中会为 <code>value</code> 绑定一个新的变量，这样每个 lambda 函数都能捕获到当前循环中的 <code>value</code>，而不是共享的全局变量。</p>
<h2 id="⭐数数"><a href="#⭐数数" class="headerlink" title="⭐数数"></a>⭐数数</h2><blockquote>
<p>计算机往往不够聪明（或者太过聪明），以至于他只会完全按照你的指令办事，尽管有时候你自己都不知道自己的指令是什么含义</p>
</blockquote>
<h3 id="CH1-3"><a href="#CH1-3" class="headerlink" title="CH1"></a>CH1</h3><p>这道题目并不难，你要做的只是让计算机学会数数而已。</p>
<p>比如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> work_load;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">worker</span><span class="params">(<span class="type">void</span> *counter_ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; work_load; i++) &#123;</span><br><span class="line">        (* (<span class="type">int</span> *)counter_ptr) += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give the workload per thread: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;work_load);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    worker(&amp;counter);</span><br><span class="line">    worker(&amp;counter);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Totally count: %d\n&quot;</span>, counter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>十分简单对吧？但是柳苏明却认为，让同一个 <code>worker</code>函数运行两遍效率太低了。为什么不雇佣两个 <code>worker</code>， 让他们同时工作呢？换句话说，他决定使用 <strong>多线程</strong>！</p>
<p>于是他十分好心的给了你两份代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// V1</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> work_load;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">worker</span><span class="params">(<span class="type">void</span> *counter_ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; work_load; i++) &#123;</span><br><span class="line">        (* (<span class="type">int</span> *)counter_ptr) += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give the workload per thread: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;work_load);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> thread1, thread2;</span><br><span class="line">    <span class="type">int</span> counter1, counter2;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;thread1, <span class="literal">NULL</span>, worker, &amp;counter1);</span><br><span class="line">    pthread_create(&amp;thread2, <span class="literal">NULL</span>, worker, &amp;counter2);</span><br><span class="line"></span><br><span class="line">    pthread_join(thread1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(thread2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Totally count: %d\n&quot;</span>, counter1 + counter2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//V2</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> work_load;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">worker</span><span class="params">(<span class="type">void</span> *counter_ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; work_load; i++) &#123;</span><br><span class="line">        (* (<span class="type">int</span> *)counter_ptr) += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give the workload per thread: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;work_load);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> thread1, thread2;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;thread1, <span class="literal">NULL</span>, worker, &amp;counter);</span><br><span class="line">    pthread_create(&amp;thread2, <span class="literal">NULL</span>, worker, &amp;counter);</span><br><span class="line"></span><br><span class="line">    pthread_join(thread1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(thread2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Totally count: %d\n&quot;</span>, counter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但问题出现了，尽管第一份代码可以正常运行，但第二份代码在 <strong>输入值很大</strong> 时总是出现奇怪的偏差。</p>
<p>尝试运行测试这两段代码，回答：</p>
<ol>
<li>为什么两份相似的代码会有不同的输出结果？</li>
</ol>
<p>V1中每个线程独立地操作各自的counter1和counter2，互不干扰，最终把两个计数器的结果加和得到答案。</p>
<p>V2中通过多线程并发地对同一变量counter进行修改，这种操作存在竞争条件。意味着两个线程可能同时读写共享变量counter，导致计数不准确，尤其是在工作负荷较大的时候。</p>
<ol start="2">
<li>在编写多线程代码时，如何避免这种错误？</li>
</ol>
<p>引入同步机制，使用互斥锁来保证线程的独立访问，确保在同一时刻只有一个线程可以操作变量，避免竞争条件。</p>
<ol start="3">
<li>尝试只修改 <code>worker</code> 函数来使第二份代码输出正确。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//V2</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> work_load; </span><br><span class="line"><span class="type">pthread_mutex_t</span> lock; <span class="comment">//锁的声明</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">worker</span><span class="params">(<span class="type">void</span> *counter_ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; work_load; i++) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;lock); <span class="comment">//上锁</span></span><br><span class="line">        (* (<span class="type">int</span> *)counter_ptr) += <span class="number">1</span>;</span><br><span class="line">        pthread_mutex_unlock(&amp;lock); <span class="comment">//解锁</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give the workload per thread: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;work_load);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> thread1, thread2;</span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line">    pthread_mutex_init(&amp;lock, <span class="literal">NULL</span>); <span class="comment">//锁的初始化</span></span><br><span class="line">    </span><br><span class="line">    pthread_create(&amp;thread1, <span class="literal">NULL</span>, worker, &amp;counter);</span><br><span class="line">    pthread_create(&amp;thread2, <span class="literal">NULL</span>, worker, &amp;counter);</span><br><span class="line"></span><br><span class="line">    pthread_join(thread1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(thread2, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_destroy(&amp;lock); <span class="comment">//销毁</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Totally count: %d\n&quot;</span>, counter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行一下，对比更改前后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./count</span><br><span class="line">give the workload per thread: 1000000000</span><br><span class="line">Totally count: 1007291379</span><br><span class="line"><span class="comment">#------------------------------------------#</span></span><br><span class="line">$ ./count</span><br><span class="line">give the workload per thread: 1000000000</span><br><span class="line">Totally count: 2000000000</span><br></pre></td></tr></table></figure>



<h3 id="CH2-3"><a href="#CH2-3" class="headerlink" title="CH2"></a>CH2</h3><p>了解”互斥锁”这个概念，思考：</p>
<blockquote>
<p>两个线程都同时访问了同一个变量：互斥锁</p>
<p>对于互斥锁的访问难道不会产生数据竞争吗？</p>
</blockquote>
<p>回答:</p>
<ol>
<li>为什么访问互斥锁不会产生数据竞争？</li>
<li>请尝试自己编写一个互斥锁(额外加分)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://imageslr.com/2020/locks.html">【操作系统】锁的实现</a></p>
<p>当一个线程获取互斥锁时，其他线程尝试获取必须等待，直到当前线程释放锁。互斥锁的实现由底层硬件或操作系统支持，通常通过某种原子操作，当一个线程访问其他线程持有的锁时，会被 OS 调度为阻塞状态（休眠），直到锁被释放后，再唤醒一个休眠的线程。</p>
<p>（另外，自旋锁是一种忙等待锁。它在锁被其他线程持有时不会阻塞当前线程，而是不断地尝试获取锁，直到锁可用为止。这种忙等待的行为称为“自旋”。）</p>
<p>使用了原子操作来实现互斥锁的加锁和解锁逻辑。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_int</span> lock_flag;</span><br><span class="line">&#125; <span class="type">my_mutex_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_mutex_init</span><span class="params">(<span class="type">my_mutex_t</span> *mutex)</span> &#123;</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;mutex-&gt;lock_flag, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_mutex_lock</span><span class="params">(<span class="type">my_mutex_t</span> *mutex)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (atomic_exchange(&amp;mutex-&gt;lock_flag, <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        sched_yield() <span class="comment">//挂起，而非忙等待</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_mutex_unlock</span><span class="params">(<span class="type">my_mutex_t</span> *mutex)</span> &#123;</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;mutex-&gt;lock_flag, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdatomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_int</span> lock_flag;</span><br><span class="line">&#125; <span class="type">my_mutex_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_mutex_init</span><span class="params">(<span class="type">my_mutex_t</span> *mutex)</span> &#123;</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;mutex-&gt;lock_flag, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_mutex_lock</span><span class="params">(<span class="type">my_mutex_t</span> *mutex)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (atomic_exchange(&amp;mutex-&gt;lock_flag, <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        sched_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_mutex_unlock</span><span class="params">(<span class="type">my_mutex_t</span> *mutex)</span> &#123;</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;mutex-&gt;lock_flag, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> work_load;</span><br><span class="line"><span class="type">my_mutex_t</span> my_mutex;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">worker</span><span class="params">(<span class="type">void</span> *counter_ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; work_load; i++) &#123;</span><br><span class="line">        my_mutex_lock(&amp;my_mutex);</span><br><span class="line">        (*(<span class="type">int</span> *)counter_ptr) += <span class="number">1</span>;</span><br><span class="line">        my_mutex_unlock(&amp;my_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give the workload per thread: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;work_load);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> thread1, thread2;</span><br><span class="line">    <span class="type">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    my_mutex_init(&amp;my_mutex);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;thread1, <span class="literal">NULL</span>, worker, &amp;counter);</span><br><span class="line">    pthread_create(&amp;thread2, <span class="literal">NULL</span>, worker, &amp;counter);</span><br><span class="line"></span><br><span class="line">    pthread_join(thread1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(thread2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Totally count: %d\n&quot;</span>, counter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="📟Bitter"><a href="#📟Bitter" class="headerlink" title="📟Bitter"></a>📟Bitter</h2><h3 id="CH1-4"><a href="#CH1-4" class="headerlink" title="CH1"></a>CH1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOARD_SIZE 8</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> upper_lim = <span class="number">1</span>;</span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* int row: store the valid bit after applying the vertical rule</span></span><br><span class="line"><span class="comment">* int ld: store the valid bit after applying the left diagram rule</span></span><br><span class="line"><span class="comment">* int rd: store the valid bit after applying the right diagram rule</span></span><br><span class="line"><span class="comment">* bit &#x27;0&#x27; represent where we can place a chess</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">solve_problem</span><span class="params">(<span class="type">int</span> row ,<span class="type">int</span> ld, <span class="type">int</span> rd)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( row == upper_lim) &#123;</span><br><span class="line">        count += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* &#x27;current&#x27; represent all the valid bit*/</span></span><br><span class="line">    <span class="type">int</span> current = upper_lim &amp; (~ (row | ld | rd));</span><br><span class="line">    <span class="type">int</span> buffer = current;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(buffer) &#123;</span><br><span class="line">        <span class="type">int</span> valid = buffer &amp; (-buffer);</span><br><span class="line">        buffer -= valid;</span><br><span class="line"></span><br><span class="line">        solve_problem(row|valid, (ld|valid)&lt;&lt;<span class="number">1</span>, (rd|valid)&gt;&gt;<span class="number">1</span>); <span class="comment">///////////////////////////////////////</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* board_size shouldn&#x27;t be too large */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">find_n_th_queen</span><span class="params">(<span class="type">int</span> board_size )</span> &#123;</span><br><span class="line">    upper_lim = (<span class="number">1</span> &lt;&lt; board_size) - <span class="number">1</span>;</span><br><span class="line">    solve_problem(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    find_n_th_queen(BOARD_SIZE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Answer: %d&quot;</span>, count);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Answer: 92</span></span><br></pre></td></tr></table></figure>

<h3 id="CH2-4"><a href="#CH2-4" class="headerlink" title="CH2"></a>CH2</h3><p>用位来标记数组元素的状态。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">nums</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(nums)</span><br><span class="line">    states = <span class="number">1</span> &lt;&lt; n</span><br><span class="line">    max_sum = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> state <span class="keyword">in</span> <span class="built_in">range</span>(states):</span><br><span class="line">        valid = <span class="literal">True</span></span><br><span class="line">        curr_sum = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            <span class="keyword">if</span> state &amp; (<span class="number">1</span> &lt;&lt; i): <span class="comment">#choose ith element</span></span><br><span class="line">                curr_sum += nums[i]</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> (state &amp; (<span class="number">1</span> &lt;&lt; (i - <span class="number">1</span>))): <span class="comment">#conflict</span></span><br><span class="line">                    valid = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> valid:</span><br><span class="line">            max_sum = <span class="built_in">max</span>(max_sum, curr_sum)</span><br><span class="line">    <span class="keyword">return</span> max_sum</span><br><span class="line"></span><br><span class="line">nums = [<span class="number">1</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">10</span>, <span class="number">19</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">18</span>, <span class="number">16</span>, <span class="number">20</span>]</span><br><span class="line"><span class="built_in">print</span>(solve(nums))</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">130</span></span><br><span class="line"><span class="string">[Done] exited with code=0 in 0.965 seconds</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>动态规划可以显著降低时间。</p>
<ul>
<li>加密算法：AES中存在行移位，哈希算法会使用位移、异或操作，提供安全性</li>
<li>快速运算：位移操作快速计算，奇偶判断，节约时间，bitset筛素数可节省空间</li>
<li>文件权限：使用位运算可以方便地开启或关闭某些标志位</li>
<li>并行计算：位运算可以快速地启用或禁用某个线程或者检查某个线程的状态</li>
</ul>
<h2 id="🎩顺手牵羊"><a href="#🎩顺手牵羊" class="headerlink" title="🎩顺手牵羊"></a>🎩顺手牵羊</h2><p><strong>要求：</strong>使用C语言实现一个自己的抓包软件</p>
<ol>
<li>使用<code>libpcap</code>库实现抓包。</li>
<li>程序应该实现：判断并输出每个包的类型，包的长度，以及包的源地址和目的地址。</li>
</ol>
<p>如果你能实现对于TCP包的捕获，可以获得70%的分数。如果你能实现至少三种包的分析捕获，可以获得剩下30%的分数。</p>
<p>简单阐述下你对抓包的实现原理的理解，最高可得额外的20%分数。</p>
<p><strong>hint：</strong>要不下载一个wireshark体验下抓包？</p>
<hr>
<p><strong>题解：</strong></p>
<p>在C语言中使用libpcap库来进行抓包操作。</p>
<p>安装libpcap库；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install libpcap-dev</span><br></pre></td></tr></table></figure>

<p>实现对TCP包的捕获；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span> <span class="comment">//提供了IP地址的转换函数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/tcp.h&gt;</span> <span class="comment">//定义了IP和TCP头部的结构体</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调函数在每次捕获到数据包时被调用</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_handler</span><span class="params">(u_char *user_data, <span class="type">const</span> <span class="keyword">struct</span> pcap_pkthdr *pkthdr, <span class="type">const</span> u_char *packet)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip</span> *<span class="title">ip_header</span> =</span> (<span class="keyword">struct</span> ip *)(packet + <span class="number">14</span>); <span class="comment">//跳过以太网帧头(14)、获取ip头</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcp_header</span> =</span> (<span class="keyword">struct</span> tcphdr *)(packet + <span class="number">14</span> + ip_header-&gt;ip_hl * <span class="number">4</span>); <span class="comment">//获取TCP头</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&lt;--------- New Packet Arrived! ---------&gt;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Total packet available: %d bytes\n&quot;</span>, pkthdr-&gt;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Expected packet size: %d bytes\n&quot;</span>, pkthdr-&gt;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;IP header length (IHL) in bytes: %d\n&quot;</span>, ip_header-&gt;ip_hl * <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Source Address: %s\n&quot;</span>, inet_ntoa(ip_header-&gt;ip_src));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Destination Address: %s\n&quot;</span>, inet_ntoa(ip_header-&gt;ip_dst));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TCP header length in bytes: %d\n&quot;</span>, tcp_header-&gt;th_off * <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Size of all headers combined: %d bytes\n&quot;</span>, ip_header-&gt;ip_hl * <span class="number">4</span> + tcp_header-&gt;th_off * <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Payload size: %d bytes\n&quot;</span>, pkthdr-&gt;len - (ip_header-&gt;ip_hl * <span class="number">4</span> + tcp_header-&gt;th_off * <span class="number">4</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------\n&quot;</span>);</span><br><span class="line">&#125; <span class="comment">//三个参数分别表示：用户传递的数据、数据包头部信息、指向实际的数据包内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> errbuf[PCAP_ERRBUF_SIZE];</span><br><span class="line">    <span class="type">pcap_if_t</span> *alldevs;</span><br><span class="line">    <span class="type">pcap_if_t</span> *device;</span><br><span class="line">    <span class="type">pcap_t</span> *handle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用函数获取所有可用设备列表</span></span><br><span class="line">    <span class="keyword">if</span> (pcap_findalldevs(&amp;alldevs, errbuf) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error finding devices: %s\n&quot;</span>, errbuf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择第一个设备</span></span><br><span class="line">    device = alldevs;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Using device: %s\n&quot;</span>, device-&gt;name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开设备</span></span><br><span class="line">    handle = pcap_open_live(device-&gt;name, BUFSIZ, <span class="number">1</span>, <span class="number">1000</span>, errbuf);</span><br><span class="line">    </span><br><span class="line">    pcap_loop(handle, <span class="number">0</span>, packet_handler, <span class="literal">NULL</span>); <span class="comment">//捕获数据包，回调</span></span><br><span class="line">    </span><br><span class="line">    pcap_freealldevs(alldevs);</span><br><span class="line">    pcap_close(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译运行上述代码，打开firefox，捕获到数据包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o packet_sniffer packet_sniffer -lpcap</span><br><span class="line">$ <span class="built_in">sudo</span> ./packet_sniffer</span><br><span class="line">Using device: loopback0</span><br><span class="line">&lt;--------- New Packet Arrived! ---------&gt;</span><br><span class="line">Total packet available: 1514 bytes</span><br><span class="line">Expected packet size: 1514 bytes</span><br><span class="line">IP header length (IHL) <span class="keyword">in</span> bytes: 20</span><br><span class="line">Source Address: 127.0.0.1</span><br><span class="line">Destination Address: 127.0.0.1</span><br><span class="line">TCP header length <span class="keyword">in</span> bytes: 32</span><br><span class="line">Size of all headers combined: 52 bytes</span><br><span class="line">Payload size: 1462 bytes</span><br><span class="line">---------------------------------------</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这些数据包是在 WSL 2 内部通过 loopback 接口进行的本地通信，源头和目的地都是127.0.0.1。查找网络接口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ip addr</span><br><span class="line">...</span><br><span class="line">4: loopback0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:15:5d:78:40:b2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether e0:2e:0b:08:09:53 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.144/24 brd 192.168.0.255 scope global noprefixroute eth2</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::66a7:f661:86e5:c634/64 scope <span class="built_in">link</span> nodad noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>发现<code>eth2</code>是当前唯一状态为 <code>UP</code> 且配置了 IP 地址的接口，是WSL主要用于与外部网络通信的接口。修改代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 查找名为 &quot;eth2&quot; 的设备</span></span><br><span class="line">    <span class="keyword">for</span> (device = alldevs; device != <span class="literal">NULL</span>; device = device-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(device-&gt;name, <span class="string">&quot;eth2&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            found = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Device eth2 not found. Make sure you have the necessary permissions.\n&quot;</span>);</span><br><span class="line">        pcap_freealldevs(alldevs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;--------- New Packet Arrived! ---------&gt;</span><br><span class="line">Total packet available: 66 bytes</span><br><span class="line">Expected packet size: 66 bytes</span><br><span class="line">IP header length (IHL) <span class="keyword">in</span> bytes: 20</span><br><span class="line">Source Address: 192.168.0.144</span><br><span class="line">Destination Address: 34.107.243.93</span><br><span class="line">TCP header length <span class="keyword">in</span> bytes: 32</span><br><span class="line">Size of all headers combined: 52 bytes</span><br><span class="line">Payload size: 14 bytes</span><br><span class="line">---------------------------------------</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>实现对TCP、UDP和ICMP三种包的捕获：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/udp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/ip_icmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调函数，用于处理捕获的数据包</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_handler</span><span class="params">(u_char *user_data, <span class="type">const</span> <span class="keyword">struct</span> pcap_pkthdr *pkthdr, <span class="type">const</span> u_char *packet)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip</span> *<span class="title">ip_header</span> =</span> (<span class="keyword">struct</span> ip *)(packet + <span class="number">14</span>); <span class="comment">// 跳过以太网头部（Ethernet header）</span></span><br><span class="line">    <span class="type">int</span> ip_header_length = ip_header-&gt;ip_hl * <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&lt;--------- New Packet Arrived! ---------&gt;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Total packet available: %d bytes\n&quot;</span>, pkthdr-&gt;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Expected packet size: %d bytes\n&quot;</span>, pkthdr-&gt;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;IP header length (IHL) in bytes: %d\n&quot;</span>, ip_header_length);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Source Address: %s\n&quot;</span>, inet_ntoa(ip_header-&gt;ip_src));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Destination Address: %s\n&quot;</span>, inet_ntoa(ip_header-&gt;ip_dst));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查IP包的协议字段以确定其类型</span></span><br><span class="line">    <span class="keyword">switch</span> (ip_header-&gt;ip_p) &#123;</span><br><span class="line">        <span class="keyword">case</span> IPPROTO_TCP: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcp_header</span> =</span> (<span class="keyword">struct</span> tcphdr *)(packet + <span class="number">14</span> + ip_header_length);</span><br><span class="line">            <span class="type">int</span> tcp_header_length = tcp_header-&gt;th_off * <span class="number">4</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Protocol: TCP\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;TCP header length in bytes: %d\n&quot;</span>, tcp_header_length);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Size of all headers combined: %d bytes\n&quot;</span>, ip_header_length + tcp_header_length);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Payload size: %d bytes\n&quot;</span>, pkthdr-&gt;len - (ip_header_length + tcp_header_length));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> IPPROTO_UDP: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">udphdr</span> *<span class="title">udp_header</span> =</span> (<span class="keyword">struct</span> udphdr *)(packet + <span class="number">14</span> + ip_header_length);</span><br><span class="line">            <span class="type">int</span> udp_header_length = <span class="number">8</span>; <span class="comment">// UDP header 固定长度为 8 字节</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Protocol: UDP\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;UDP header length in bytes: %d\n&quot;</span>, udp_header_length);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Size of all headers combined: %d bytes\n&quot;</span>, ip_header_length + udp_header_length);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Payload size: %d bytes\n&quot;</span>, ntohs(udp_header-&gt;len) - udp_header_length);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> IPPROTO_ICMP: &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">icmphdr</span> *<span class="title">icmp_header</span> =</span> (<span class="keyword">struct</span> icmphdr *)(packet + <span class="number">14</span> + ip_header_length);</span><br><span class="line">            <span class="type">int</span> icmp_header_length = <span class="number">8</span>; <span class="comment">// ICMP header 通常为 8 字节</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Protocol: ICMP\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ICMP header length in bytes: %d\n&quot;</span>, icmp_header_length);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Size of all headers combined: %d bytes\n&quot;</span>, ip_header_length + icmp_header_length);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Payload size: %d bytes\n&quot;</span>, pkthdr-&gt;len - (ip_header_length + icmp_header_length));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Protocol: Other\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> errbuf[PCAP_ERRBUF_SIZE];</span><br><span class="line">    <span class="type">pcap_if_t</span> *alldevs;</span><br><span class="line">    <span class="type">pcap_if_t</span> *device;</span><br><span class="line">    <span class="type">pcap_t</span> *handle;</span><br><span class="line">    <span class="type">int</span> found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 pcap_findalldevs 来获取所有可用设备</span></span><br><span class="line">    <span class="keyword">if</span> (pcap_findalldevs(&amp;alldevs, errbuf) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error finding devices: %s\n&quot;</span>, errbuf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找名为 &quot;eth2&quot; 的设备</span></span><br><span class="line">    <span class="keyword">for</span> (device = alldevs; device != <span class="literal">NULL</span>; device = device-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(device-&gt;name, <span class="string">&quot;eth2&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            found = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Device eth2 not found. Make sure you have the necessary permissions.\n&quot;</span>);</span><br><span class="line">        pcap_freealldevs(alldevs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Using device: %s\n&quot;</span>, device-&gt;name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开设备</span></span><br><span class="line">    handle = pcap_open_live(device-&gt;name, BUFSIZ, <span class="number">1</span>, <span class="number">1000</span>, errbuf);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Could not open device %s: %s\n&quot;</span>, device-&gt;name, errbuf);</span><br><span class="line">        pcap_freealldevs(alldevs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始捕获数据包</span></span><br><span class="line">    pcap_loop(handle, <span class="number">0</span>, packet_handler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放设备列表</span></span><br><span class="line">    pcap_freealldevs(alldevs);</span><br><span class="line"></span><br><span class="line">    pcap_close(handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行代码抓包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;--------- New Packet Arrived! ---------&gt;</span><br><span class="line">Total packet available: 90 bytes</span><br><span class="line">Expected packet size: 90 bytes</span><br><span class="line">IP header length (IHL) <span class="keyword">in</span> bytes: 20</span><br><span class="line">Source Address: 185.125.190.57</span><br><span class="line">Destination Address: 192.168.0.144</span><br><span class="line">Protocol: UDP</span><br><span class="line">UDP header length <span class="keyword">in</span> bytes: 8</span><br><span class="line">Size of all headers combined: 28 bytes</span><br><span class="line">Payload size: 48 bytes</span><br><span class="line">---------------------------------------</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>首先找到可用的网络接口，确保抓包工具监听到指定网络接口上的所有数据包；打开网络接口，置于混杂模式（1），以便捕获所有经过该接口的数据包；循环捕获包，调用回调函数，解析IP包头的字段，判断包所使用的传输层协议等等。</p>
<blockquote>
<p>libpcap通过操作系统的网络驱动从链路层捕获数据包，将其暂存在内核缓冲区中，然后将数据包传递到用户空间供应用程序分析。</p>
</blockquote>
<p>参考内容：</p>
<p><a target="_blank" rel="noopener" href="https://docs.pingcode.com/baike/1020340">C语言如何做抓包</a></p>
<h2 id="👿busin的野心"><a href="#👿busin的野心" class="headerlink" title="👿busin的野心"></a>👿busin的野心</h2><p><strong>要求：</strong>请你写个程序，自动检测排行榜的变化。具体有如下两个需求：</p>
<ol>
<li>招新网站的排行榜包含10个招新相关方向以及一个总分方向。如果这11个类别中的任意一个<strong>排行的前十名</strong>发生了变化，程序就会打印：1.新的前十名排行 2.哪一个人掉出了前十名 3.哪一个人进入了前十名。</li>
<li>程序应该监测特定的题目（使用动态容器的题目可以不被监测）。当有人通过了这个题目后，程序会按照<code>f&quot;passer: &#123;user_name&#125;, task: &#123;task_name&#125;, time: &#123;passing_time&#125;&quot;</code>打印出这条信息。</li>
</ol>
<p>将程序部署在服务器上实现24h运行，并能通过社交软件&#x2F;邮箱&#x2F;其他能从移动设备上接收到更新信息的方式，将信息发送到你的移动设备上，实现可视化的管理界面。 (ps:这可能需要一点SA的知识）</p>
<hr>
<p><strong>题解：</strong>首先编写程序<code>rank.py</code>实现打印排名变化情况。</p>
<p>在<a target="_blank" rel="noopener" href="https://recruit.cnss.io/#/rank%E4%B8%8A%EF%BC%8C%E5%88%B7%E6%96%B0%E9%A1%B5%E9%9D%A2%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%89%BE%E5%88%B0%E4%BA%86fullrank%EF%BC%8C%E5%85%B6%E9%80%9A%E8%BF%87XHR%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%E8%AF%A5%E8%AF%B7%E6%B1%82%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E7%9A%84%E3%80%82%E4%BA%8E%E6%98%AF%E6%88%91%E4%BB%AC%E6%A8%A1%E6%8B%9F%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%8C**%E7%94%B1%E4%BA%8EToken%E5%9C%A8%E9%9A%8F%E7%9D%80%E6%97%B6%E9%97%B4%E5%8F%98%E5%8C%96%EF%BC%8C%E4%BA%8E%E6%98%AF%E6%B7%BB%E5%8A%A0%E6%89%8B%E5%8A%A8%E8%BE%93%E5%85%A5Token%E7%9A%84%E9%83%A8%E5%88%86%EF%BC%9A">https://recruit.cnss.io/#/rank上，刷新页面在浏览器控制台网络中找到了fullrank，其通过XHR获取数据，说明排行榜的数据可能是通过该请求动态加载的。于是我们模拟浏览器的请求，**由于Token在随着时间变化，于是添加手动输入Token的部分：</a>**</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">url, token</span>):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json, text/plain, */*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate, br, zstd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;recruit.cnss.io:8443&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://recruit.cnss.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://recruit.cnss.io/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA&quot;</span>: <span class="string">&#x27;&quot;Google Chrome&quot;;v=&quot;129&quot;, &quot;Not=A?Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;129&quot;&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA-Mobile&quot;</span>: <span class="string">&quot;?0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA-Platform&quot;</span>: <span class="string">&#x27;&quot;Windows&quot;&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Dest&quot;</span>: <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-site&quot;</span>,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Token&quot;</span>: token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, headers=headers)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> response.json()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to fetch rankings. HTTP Status Code: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Response content: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error fetching rankings: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主函数流程，记录old_rankings.json文件，fetch得到new_rankings，对新旧排行进行比较，打印信息，更新old_rankings。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://recruit.cnss.io:8443/v1/fullrank&quot;</span></span><br><span class="line">    token = <span class="built_in">input</span>(<span class="string">&quot;Please enter your access token: &quot;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Your Token cannot be NULL.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;old_rankings.json&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            old_rankings = json.load(file)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        old_rankings = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    new_rankings = fetch(url, token)</span><br><span class="line">    <span class="keyword">if</span> new_rankings:</span><br><span class="line">        changes = compare(old_rankings, new_rankings)</span><br><span class="line">        print_changes(changes)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;old_rankings.json&quot;</span>, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            json.dump(new_rankings, file, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面是compare和print函数</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compare</span>(<span class="params">old_rankings, new_rankings</span>):</span><br><span class="line">    changes = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> direction, new_top10 <span class="keyword">in</span> new_rankings.items():</span><br><span class="line">        old_top10 = old_rankings.get(direction, [])</span><br><span class="line"></span><br><span class="line">        old_top10_users = [item[<span class="string">&#x27;Name&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> old_top10[:<span class="number">10</span>] <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> item]</span><br><span class="line">        new_top10_users = [item[<span class="string">&#x27;Name&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> new_top10[:<span class="number">10</span>] <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> item]</span><br><span class="line"></span><br><span class="line">        entered = <span class="built_in">set</span>(new_top10_users) - <span class="built_in">set</span>(old_top10_users)</span><br><span class="line">        dropped = <span class="built_in">set</span>(old_top10_users) - <span class="built_in">set</span>(new_top10_users)</span><br><span class="line"></span><br><span class="line">        order_changed = old_top10_users != new_top10_users <span class="comment">#judge</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> entered <span class="keyword">or</span> dropped <span class="keyword">or</span> order_changed:</span><br><span class="line">            changes[direction] = &#123;</span><br><span class="line">                <span class="string">&#x27;new_top10&#x27;</span>: [&#123;<span class="string">&#x27;Name&#x27;</span>: item[<span class="string">&#x27;Name&#x27;</span>], <span class="string">&#x27;Score&#x27;</span>: item[<span class="string">&#x27;Score&#x27;</span>]&#125; <span class="keyword">for</span> item <span class="keyword">in</span> new_top10[:<span class="number">10</span>] <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> item],</span><br><span class="line">                <span class="string">&#x27;entered&#x27;</span>: <span class="built_in">list</span>(entered),</span><br><span class="line">                <span class="string">&#x27;dropped&#x27;</span>: <span class="built_in">list</span>(dropped),</span><br><span class="line">                <span class="string">&#x27;order_changed&#x27;</span>: order_changed</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> changes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_changes</span>(<span class="params">changes</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> changes:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;排名未发生变化。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> direction, details <span class="keyword">in</span> changes.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n方向: <span class="subst">&#123;direction&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;新的前十名排行:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> rank, user <span class="keyword">in</span> <span class="built_in">enumerate</span>(details[<span class="string">&#x27;new_top10&#x27;</span>], start=<span class="number">1</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  名次 <span class="subst">&#123;rank&#125;</span>: <span class="subst">&#123;user[<span class="string">&#x27;Name&#x27;</span>]&#125;</span> (得分: <span class="subst">&#123;user[<span class="string">&#x27;Score&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> details[<span class="string">&#x27;entered&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;进入前十名的人: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(details[<span class="string">&#x27;entered&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;没有新进入前十名的人。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> details[<span class="string">&#x27;dropped&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;掉出前十名的人: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(details[<span class="string">&#x27;dropped&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;没有掉出前十名的人。&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> details[<span class="string">&#x27;order_changed&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;前十名内部顺序发生了变化。&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行一下，得到输出。</p>
<p>接下来我们编写<code>task.py</code>程序。以一道题为例，我的思路是先在题目<code>tasks</code>那个页面，捕获特定题目的<code>pass_number</code>，当通过人数发生变化时，遍历用户，在<code>passrecord</code>寻找该题的通过者，<strong>异步化</strong>代码实现如下</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Rocky006/article/details/134182815">Python异步网络编程利器——详解aiohttp的使用教程</a></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">TASK_URL = <span class="string">&quot;https://recruit.cnss.io:8443/v1/tasks/534&quot;</span></span><br><span class="line">PASSRECORD_URL_TEMPLATE = <span class="string">&quot;https://recruit.cnss.io:8443/v1/passrecord/&#123;&#125;&quot;</span></span><br><span class="line">TARGET_TASK_TITLE = <span class="string">&quot;👿busin的野心&quot;</span></span><br><span class="line">USER_ID_RANGE = <span class="built_in">range</span>(<span class="number">530</span>, <span class="number">535</span>)</span><br><span class="line">SLEEP_INTERVAL = <span class="number">6</span></span><br><span class="line"></span><br><span class="line">previous_pass_number = <span class="literal">None</span></span><br><span class="line">user_submissions = &#123;&#125;</span><br><span class="line">token = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_pass_number</span>(<span class="params">session</span>):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json, text/plain, */*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate, br, zstd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;recruit.cnss.io:8443&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://recruit.cnss.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://recruit.cnss.io/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA&quot;</span>: <span class="string">&#x27;&quot;Google Chrome&quot;;v=&quot;129&quot;, &quot;Not=A?Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;129&quot;&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA-Mobile&quot;</span>: <span class="string">&quot;?0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA-Platform&quot;</span>: <span class="string">&#x27;&quot;Windows&quot;&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Dest&quot;</span>: <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-site&quot;</span>,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Token&quot;</span>: token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(TASK_URL, headers=headers) <span class="keyword">as</span> response:</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            data = <span class="keyword">await</span> response.json()</span><br><span class="line"></span><br><span class="line">            tasks = data.get(<span class="string">&#x27;dev&#x27;</span>, [])</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">                <span class="keyword">if</span> task.get(<span class="string">&#x27;title&#x27;</span>) == TARGET_TASK_TITLE:</span><br><span class="line">                    <span class="keyword">return</span> task.get(<span class="string">&#x27;pass_number&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> aiohttp.ClientError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取任务数据时发生异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理任务数据时发生异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_user_submission</span>(<span class="params">session, user_id</span>):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json, text/plain, */*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate, br, zstd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;recruit.cnss.io:8443&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://recruit.cnss.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://recruit.cnss.io/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA&quot;</span>: <span class="string">&#x27;&quot;Google Chrome&quot;;v=&quot;129&quot;, &quot;Not=A?Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;129&quot;&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA-Mobile&quot;</span>: <span class="string">&quot;?0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-CH-UA-Platform&quot;</span>: <span class="string">&#x27;&quot;Windows&quot;&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Dest&quot;</span>: <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-site&quot;</span>,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Token&quot;</span>: token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    url = PASSRECORD_URL_TEMPLATE.<span class="built_in">format</span>(user_id)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> response:</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.json()</span><br><span class="line">    <span class="keyword">except</span> aiohttp.ClientError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;获取用户 <span class="subst">&#123;user_id&#125;</span> 的数据时出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理用户 <span class="subst">&#123;user_id&#125;</span> 的数据时出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整个函数的逻辑是这样的：通过fetch初始化每个用户（这里是530到535）的提交内容，记录下来，然后每6秒去监测特定题目的通过人数有没有发生变化，一旦发生变化，调用check函数遍历比对，打印出信息。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> token</span><br><span class="line">    token = <span class="built_in">input</span>(<span class="string">&quot;请输入Token: &quot;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Token不能为空。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    user_ids = USER_ID_RANGE</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">await</span> initialize_user_records(session, user_ids)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">await</span> monitor_pass_number(session, user_ids)</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(SLEEP_INTERVAL)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        asyncio.run(main())</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n程序已手动终止。&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>下面我们完善遍历用户，进行初始化用户的提交内容：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">initialize_user_records</span>(<span class="params">session, user_ids</span>):</span><br><span class="line">    <span class="keyword">global</span> user_submissions</span><br><span class="line">    tasks = [fetch_user_submission(session, user_id) <span class="keyword">for</span> user_id <span class="keyword">in</span> user_ids]</span><br><span class="line">    submissions = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">    <span class="keyword">for</span> user_id, submission <span class="keyword">in</span> <span class="built_in">zip</span>(user_ids, submissions):</span><br><span class="line">        <span class="keyword">if</span> submission <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            user_submissions[user_id] = submission</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;初始记录已保存用户 <span class="subst">&#123;user_id&#125;</span>。&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;未能获取用户 <span class="subst">&#123;user_id&#125;</span> 的初始记录。&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>接着监测特定题目人数并在变化时遍历：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">monitor_pass_number</span>(<span class="params">session, user_ids</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> previous_pass_number</span><br><span class="line">    current_pass_number = <span class="keyword">await</span> fetch_pass_number(session)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current_pass_number <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> previous_pass_number <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            previous_pass_number = current_pass_number</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;初始 pass_number: <span class="subst">&#123;current_pass_number&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> current_pass_number &gt; previous_pass_number:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;pass_number 增加了！新的 pass_number: <span class="subst">&#123;current_pass_number&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">await</span> check_user_submission_changes(session, user_ids)</span><br><span class="line">            previous_pass_number = current_pass_number</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;当前 pass_number: <span class="subst">&#123;current_pass_number&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;无法获取 pass_number&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_user_submission_changes</span>(<span class="params">session, user_ids</span>):</span><br><span class="line">    <span class="keyword">global</span> user_submissions</span><br><span class="line"></span><br><span class="line">    tasks = [fetch_user_submission(session, user_id) <span class="keyword">for</span> user_id <span class="keyword">in</span> user_ids]</span><br><span class="line">    submissions = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> user_id, new_submission <span class="keyword">in</span> <span class="built_in">zip</span>(user_ids, submissions):</span><br><span class="line">        <span class="keyword">if</span> new_submission <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        previous_submission = user_submissions.get(user_id, [])</span><br><span class="line">        new_tasks = &#123;task[<span class="string">&#x27;TaskID&#x27;</span>]: task <span class="keyword">for</span> task <span class="keyword">in</span> new_submission&#125;</span><br><span class="line">        old_tasks = &#123;task[<span class="string">&#x27;TaskID&#x27;</span>]: task <span class="keyword">for</span> task <span class="keyword">in</span> previous_submission&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> task_id, new_task <span class="keyword">in</span> new_tasks.items():</span><br><span class="line">            old_task = old_tasks.get(task_id)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> old_task <span class="keyword">or</span> old_task.get(<span class="string">&#x27;Score&#x27;</span>) != new_task.get(<span class="string">&#x27;Score&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> new_task.get(<span class="string">&#x27;TaskTitle&#x27;</span>) == TARGET_TASK_TITLE:</span><br><span class="line">                    user_name = <span class="string">f&quot;User <span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">                    task_name = new_task.get(<span class="string">&#x27;TaskTitle&#x27;</span>)</span><br><span class="line">                    passing_time = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;passer: <span class="subst">&#123;user_name&#125;</span>, task: <span class="subst">&#123;task_name&#125;</span>, time: <span class="subst">&#123;passing_time&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        user_submissions[user_id] = new_submission    </span><br></pre></td></tr></table></figure>

<p>运行上述代码，得到输出结果。速度有明显提升。</p>
<h2 id="🤖GPT2"><a href="#🤖GPT2" class="headerlink" title="🤖GPT2"></a>🤖GPT2</h2><p><strong>目标：</strong>你可能已经发现了，你的程序可能并没有我演示的跑的那么快（<del>神机请忽略</del>）。</p>
<p>你的目标就是优化该程序的性能，在保证结果不变的情况下更快的完成文本的补全。</p>
<p>我会使用一些测试点来评测你的程序的正确性和执行时间。期待更高的效率和更多样的优化方案。</p>
<p>此外，请在 wp 中回答下面的问题：</p>
<ul>
<li>什么是阿姆达尔定律？根据阿姆达尔定律，我们应该把优化的重点放在哪里？</li>
<li>你的优化方案和思路是什么？优化的效果受到哪些因素影响？</li>
</ul>
<hr>
<p><strong>题解：</strong>按照指示完成GPT2，make运行一下，发现需要20多秒。</p>
<p>阿姆达尔定律是一个经验法则，代表处理器并行运算之后效率提升的能力。在并行计算中，使用多个处理器的程序的加速比受限制于程序<em><strong>串行部分</strong></em>的执行时间。<br>$$<br>s(n)&#x3D;\frac{1}{B+(1-B)&#x2F;n}<br>$$</p>
<ul>
<li>$s(n):$ 固定负载下，理论上的加速比</li>
<li>$B:$ 串行工作部分所占比例，取值0~1</li>
<li>$n:$ 并行线程数，并行处理节点个数</li>
</ul>
<p>可以看出，即使我们增加处理器数量，只能对并行部分产生影响，而对非并行部分没有任何影响。因此随着处理器数量增加，整体性能的提升会趋于平缓。</p>
<p>根据阿姆达尔定律，应该将优化重点放在<strong>最小化串行部分，同时最大化可并行部分</strong>。</p>
<p>浏览源<code>gpt.c</code>代码中注意到，存在矩阵乘法、注意力机制和涉及大量计算的循环，可以进行并行计算，将任务分配到多个处理器上，使用OpenMP并行化矩阵乘法、前馈神经网络层等。</p>
<p>具体操作是在<code>matmul_forward</code>和<code>attention_forward</code>函数循环前添加代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for collapse(2)</span></span><br></pre></td></tr></table></figure>

<p>同时，在MakeFile中开启编译选项<code>-fopenmp</code>。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">release:</span></span><br><span class="line">	cc gpt.c -lm -O3 -fopenmp -Wno-unused-result -Wno-unused-value -Wno-unused-variable -o gpt</span><br><span class="line"></span><br><span class="line"><span class="section">debug:</span></span><br><span class="line">	cc gpt.c -lm -O1 -g -fopenmp -Wno-unused-result -Wno-unused-value -Wno-unused-variable -o gpt</span><br></pre></td></tr></table></figure>

<p>前后对比一下</p>
<p>在保证结果不变的情况下更快的（5~6秒)完成了文本的补全。</p>
<p>优化效果受影响的因素：</p>
<ul>
<li>串行部分：总加速比会受到制约</li>
<li>硬件资源：可用处理器的数量和硬件的性能</li>
<li>编译器的优化程度</li>
<li>并行化的开销。</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>CNSS Recruit 2024 Dev wp</p><p><a href="http://aununo.xyz/2024/09/30/CNSS Recruit 2024 Dev wp/">http://aununo.xyz/2024/09/30/CNSS Recruit 2024 Dev wp/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Aununo Gan</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-09-30</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i> </a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i> </a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i> </a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/Dev/">Dev, </a><a class="link-muted" rel="tag" href="/tags/CNSS/">CNSS </a></div></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/" alt="Alipay"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="https://pic1.imgdb.cn/item/6810a12858cb8da5c8d45496.png" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/08/07/CNSS-Summer-Camp-2024%20wp/"><span class="level-item">CNSS Summer-Camp 2024 wp</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level" style="margin-bottom:1rem"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Aununo"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Aununo</p><p class="is-size-6 is-block">Identity follows your actions.</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Chengdu, China</span></p></div></div></nav><nav class="level menu-list is-mobile" style="margin-bottom:1rem"><a class="level-item has-text-centered is-marginless" href="/archives/"><div><p class="heading">Posts</p><div><p class="title">4</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/categories/"><div><p class="heading">Categories</p><div><p class="title">3</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/tags/"><div><p class="heading">Tags</p><div><p class="title">9</p></div></div></a></nav><div class="level"><a class="level-item button is-primary is-rounded" href="mailto:ganrunzhuo@gmail.com" target="_blank" rel="noopener"><i class="fas fa-envelope"></i>  Email Me</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/Aununo"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#🥳MAN！"><span class="level-left"><span class="level-item">1</span><span class="level-item">🥳MAN！</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CH1"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">CH1</span></span></a></li><li><a class="level is-mobile" href="#CH2"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">CH2</span></span></a></li><li><a class="level is-mobile" href="#CH3"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">CH3</span></span></a></li></ul></li><li><a class="level is-mobile" href="#😶‍🌫️Oop-Loop"><span class="level-left"><span class="level-item">2</span><span class="level-item">😶‍🌫️Oop Loop</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CH1-1"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">CH1</span></span></a></li><li><a class="level is-mobile" href="#CH2-1"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">CH2</span></span></a></li></ul></li><li><a class="level is-mobile" href="#♿造轮子"><span class="level-left"><span class="level-item">3</span><span class="level-item">♿造轮子</span></span></a></li><li><a class="level is-mobile" href="#⚒️Dig-and-Dig"><span class="level-left"><span class="level-item">4</span><span class="level-item">⚒️Dig and Dig</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CH1-2"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">CH1</span></span></a></li><li><a class="level is-mobile" href="#CH2-2"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">CH2</span></span></a></li></ul></li><li><a class="level is-mobile" href="#🧮Primes"><span class="level-left"><span class="level-item">5</span><span class="level-item">🧮Primes</span></span></a></li><li><a class="level is-mobile" href="#⭐数数"><span class="level-left"><span class="level-item">6</span><span class="level-item">⭐数数</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CH1-3"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">CH1</span></span></a></li><li><a class="level is-mobile" href="#CH2-3"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">CH2</span></span></a></li></ul></li><li><a class="level is-mobile" href="#📟Bitter"><span class="level-left"><span class="level-item">7</span><span class="level-item">📟Bitter</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CH1-4"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">CH1</span></span></a></li><li><a class="level is-mobile" href="#CH2-4"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">CH2</span></span></a></li></ul></li><li><a class="level is-mobile" href="#🎩顺手牵羊"><span class="level-left"><span class="level-item">8</span><span class="level-item">🎩顺手牵羊</span></span></a></li><li><a class="level is-mobile" href="#👿busin的野心"><span class="level-left"><span class="level-item">9</span><span class="level-item">👿busin的野心</span></span></a></li><li><a class="level is-mobile" href="#🤖GPT2"><span class="level-left"><span class="level-item">10</span><span class="level-item">🤖GPT2</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Aununo&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 Aununo Gan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>